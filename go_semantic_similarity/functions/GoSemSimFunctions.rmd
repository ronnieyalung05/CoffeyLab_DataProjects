```{r}
  # --- Load libraries ---
  if(!requireNamespace("clusterProfiler", quietly = TRUE)) install.packages("clusterProfiler")
  if(!requireNamespace("GOSemSim", quietly = TRUE)) install.packages("GOSemSim")
  if(!requireNamespace("org.Hs.eg.db", quietly = TRUE)) BiocManager::install("org.Hs.eg.db")
  if(!requireNamespace("ggtree", quietly = TRUE)) install.packages("ggtree")
  if(!requireNamespace("ape", quietly = TRUE)) install.packages("ape")
  if(!requireNamespace("pheatmap", quietly = TRUE)) install.packages("pheatmap")
  if(!requireNamespace("reshape2", quietly = TRUE)) install.packages("reshape2")
  if(!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
  
  library(clusterProfiler)
  library(GOSemSim)
  library(org.Hs.eg.db)
  library(ggtree)
  library(ape)
  library(pheatmap)
  library(reshape2)
  library(ggplot2)
  library(AnnotationDbi)
  library(tidyr)
    library(GOSemSim)
    library(clusterProfiler)
    library(org.Hs.eg.db)
    library(pheatmap)
    library(DOSE)       # for simplot
    library(ggtree)
    library(ape)
    library(ggplot2)

```


```{r}
run_sample_semantic_analysis <- function(sample_list) {
  
  # --- Step 1: Select sample ---
  cat("Available samples:\n")
  sample_names <- names(sample_list)
  for (i in seq_along(sample_names)) cat(i, ":", sample_names[i], "\n")
  
  sample_index <- as.integer(readline(prompt = "Enter the number of the sample you want to analyze: "))
  if(is.na(sample_index) || sample_index < 1 || sample_index > length(sample_names)) stop("Invalid selection.")
  
  selected_sample <- sample_list[[sample_index]]
  sample_col <- which(colnames(selected_sample) != "GeneSymbol")
  expr_vector <- selected_sample[[sample_col]]
  gene_symbols <- as.character(selected_sample$GeneSymbol)
  
  # --- Step 2: Top N genes ---
  top_n <- as.integer(readline(prompt = "Enter the number of top expressed genes to select: "))
  if(is.na(top_n) || top_n < 1) stop("Invalid number.")
  
  top_genes <- gene_symbols[order(expr_vector, decreasing = TRUE)][1:top_n]
  
  # --- Step 3: Filter valid SYMBOLs ---
  valid_symbols <- keys(org.Hs.eg.db, keytype = "SYMBOL")
  top_genes_valid <- intersect(top_genes, valid_symbols)
  omitted <- setdiff(top_genes, top_genes_valid)
  cat(length(omitted), "gene(s) were not found in org.Hs.eg.db and will be skipped:\n")
  if(length(omitted) > 0) print(omitted)
  
  cat("Number of usable genes for semantic similarity:", length(top_genes_valid), "\n")
  if(length(top_genes_valid) < 2) stop("Too few genes for semantic similarity. Increase top N.")
  
  # --- Step 4: GO semantic data ---
  cat("Preparing GO semantic data...\n")
  hsGO <- godata("org.Hs.eg.db", ont = "BP", keytype = "SYMBOL") # SYMBOL-based
  
  # --- Step 5: Compute semantic similarity ---
  sim <- mgeneSim(top_genes_valid, semData = hsGO, measure = "Wang", drop = "IEA", combine = "BMA") 
  
  # --- Step 6: Heatmap ---
  cat("Plotting semantic similarity heatmap...\n")
  pheatmap(sim, 
           clustering_method = "ward.D", 
           color = colorRampPalette(c("white", "red"))(50),
           display_numbers = TRUE,
           number_format = "%.2f",
           main = paste("Semantic similarity heatmap:", sample_names[sample_index]))
  
  # --- Step 7: Dendrogram ---
  cat("Plotting dendrogram...\n")
  hc <- hclust(as.dist(1 - sim), method = "ward.D")
  p <- ggtree(hc) + geom_tiplab() + xlim(NA, 0.5)
  print(p)
  
  # --- Step 8: Return similarity matrix ---
  return(sim)
}

```
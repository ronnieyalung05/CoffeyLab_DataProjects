```{r}
run_gost_single_sample <- function(g_protein_list) {
  # Same as your original, just renamed
  cat("Available proteins:\n")
  print(names(g_protein_list))
  
  protein_input <- readline(prompt = "\nEnter ONE sample name from the list above: ")
  
  if (!(protein_input %in% names(g_protein_list))) {
    stop(paste0("Error: '", protein_input, "' is not a valid protein name.\n",
                "Valid options are: ", paste(names(g_protein_list), collapse = ", ")))
  }
  
  cat("\nAvailable sources include: GO:BP, GO:MF, GO:CC, KEGG, REAC, WP, CORUM, TF, MIRNA, HPA, HP\n")
  source_input <- readline(prompt = "Enter one or more sources (comma-separated): ")
  sources <- trimws(strsplit(source_input, ",")[[1]])
  
  valid_sources <- c("GO:BP", "GO:MF", "GO:CC", "KEGG", "REAC", "WP", "CORUM", "TF", "MIRNA", "HPA", "HP")
  if (!all(sources %in% valid_sources)) {
    invalid <- sources[!sources %in% valid_sources]
    stop(paste0("Invalid source(s): ", paste(invalid, collapse = ", "),
                "\nValid options are: ", paste(valid_sources, collapse = ", ")))
  }
  
  gpr_filter_df <- g_protein_list[[protein_input]]
  gpr_list <- list(gpr_filter_df$GeneSymbol)
  
  safe_gost <- function(query, sources, max_attempts = 5) {
    for (i in 1:max_attempts) {
      result <- try(
        gost(
          query = query,
          organism = "hsapiens",
          ordered_query = TRUE,
          significant = TRUE,
          sources = sources
        ),
        silent = TRUE
      )
      if (!inherits(result, "try-error") && !is.null(result)) {
        return(result)
      }
      cat("Attempt", i, "failed — retrying in 2 seconds...\n")
      Sys.sleep(2)
    }
    stop("g:Profiler request failed after multiple attempts")
  }
  
  gost_results <- safe_gost(gpr_list, sources)
  
  cat("\n✅ g:Profiler analysis complete!\n")
  return(gost_results)
}

run_gost_multi_sample_one_source <- function(gpr_list) {
  # Ask user for source
  cat("\nAvailable sources: GO:BP, GO:MF, GO:CC, KEGG, REAC, WP, CORUM, TF, MIRNA, HPA, HP\n")
  source_input <- readline(prompt = "Enter ONE source from the list above: ")
  source_input <- trimws(source_input)
  
  valid_sources <- c("GO:BP", "GO:MF", "GO:CC", "KEGG", "REAC", "WP",
                     "CORUM", "TF", "MIRNA", "HPA", "HP")
  if (!(source_input %in% valid_sources)) {
    stop(paste0("Invalid source: ", source_input,
                "\nValid options are: ", paste(valid_sources, collapse = ", ")))
  }
  
  cat("Running g:Profiler for all samples using source:", source_input, "...\n")
  
  # Loop over samples
  results_list <- lapply(names(gpr_list), function(sample_name) {
    cat("Processing sample:", sample_name, "...\n")
    genes <- gpr_list[[sample_name]]$GeneSymbol
    
    safe_gost <- function(query, source, max_attempts = 5) {
      for (i in 1:max_attempts) {
        result <- try(
          gost(
            query = query,
            organism = "hsapiens",
            ordered_query = TRUE,
            significant = TRUE,
            sources = source
          ),
          silent = TRUE
        )
        if (!inherits(result, "try-error") && !is.null(result)) {
          return(result)
        }
        cat("Attempt", i, "failed — retrying in 2 seconds...\n")
        Sys.sleep(2)
      }
      warning(paste0("g:Profiler request failed for sample ", sample_name))
      return(NULL)
    }
    
    safe_gost(genes, source_input)
  })
  
  names(results_list) <- names(gpr_list)
  cat("\n✅ Multi-sample g:Profiler analysis complete!\n")
  return(results_list)
}


run_gost_menu <- function(gpr_list) {
  # Define available options
  options <- c(
    "Single sample, multiple sources",
    "All samples, ONE source, results separate"
  )
  
  # Display menu
  cat("\nSelect a g:Profiler analysis option by entering the number:\n")
  for (i in seq_along(options)) {
    cat(sprintf("[%d] %s\n", i, options[i]))
  }
  
  # Prompt user until valid input
  repeat {
    choice <- readline(prompt = "\nEnter option number: ")
    
    # Check if input is numeric and in valid range
    if (!grepl("^[0-9]+$", choice)) {
      cat("Invalid input. Please enter a number.\n")
      next
    }
    choice <- as.integer(choice)
    if (choice < 1 || choice > length(options)) {
      cat("Invalid option. Please select a number between 1 and", length(options), "\n")
      next
    }
    
    # Valid choice, break loop
    break
  }
  
  # Map choice to function
  func <- switch(choice,
                 run_gost_single_sample,
                 run_gost_multi_sample_one_source
  )
  
  # Run the selected function with error handling
  result <- tryCatch({
    func(gpr_list)
  }, error = function(e) {
    cat("\n❌ Error while running selected function:\n", e$message, "\n")
    return(NULL)
  })
  
  cat("\n✅ Selected g:Profiler function completed.\n")
  return(result)
}
```